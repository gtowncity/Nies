<!DOCTYPE html>
<html lang="de"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nies-O-Mat</title>
<style>body{font-family:Segoe UI,Arial,sans-serif;margin:0;padding:24px} .btn{padding:8px 12px;border:1px solid #333;background:#ffe38a;cursor:pointer} .tab{padding:6px 10px;margin-right:6px;border:1px solid #333;background:#eee} .tab.active{background:#ffc25c} table{border-collapse:collapse;width:100%} td,th{border-bottom:1px solid #ccc;padding:6px}</style>
</head><body>
<nav><button class="tab active" data-nav="nies">Nies‑o‑Mat</button><button class="tab" data-nav="wetter">Wetter</button></nav>
<section id="view-nies">
  <div>Heute: <span id="today-date">--.--.----</span> | <strong id="today-value">0</strong></div>
  <p><button class="btn" data-action="inc">+1</button>
     <button class="btn" data-action="dec">↶ Rückgängig</button>
     <button class="btn" data-action="reset">Heute zurücksetzen</button>
     <button class="btn" data-action="share">Teilen (bearbeitbar)</button>
     <input id="share-link" style="width:50%" readonly placeholder="Link erscheint hier"/>
  </p>
  <table><thead><tr><th>Datum</th><th>Nieser</th><th>Aktion</th></tr></thead><tbody id="days-body"></tbody></table>
</section>
<section id="view-wetter" hidden>
  <p><input id="weather-q" placeholder="Ort…"><button class="btn" data-weather="search">Suchen</button>
     <button class="btn" data-weather="refresh">Aktualisieren</button>
     <label><input id="weather-auto" type="checkbox" checked> Auto‑Update</label></p>
  <div><strong id="weather-location">—</strong></div>
  <div>Temp: <span id="w-now-temp">—</span> | Gefühl: <span id="w-now-feels">—</span> | Regen: <span id="w-now-rain">—</span> | Wind: <span id="w-now-wind">—</span> | <span id="w-now-desc">—</span></div>
  <table><thead><tr><th>Datum</th><th>Max/Min</th><th>Regen (mm)</th><th>Wetter</th></tr></thead><tbody id="w-forecast"></tbody></table>
</section>
<script>
"use strict";(function(){
  const STORAGE_KEY='sneezeCounterDataV2';
  let data={}, _currentDay=null, sharedMode=false, liveMode=false, roomId=null, es=null, lastHash='';

  const pad=n=>String(n).padStart(2,'0');
  const todayKey=(d=new Date())=>[d.getFullYear(),pad(d.getMonth()+1),pad(d.getDate())].join('-');
  const displayDateFromKey=k=>{const [y,m,d]=k.split('-'); return `${d}.${m}.${y}`};

  const toSnap=o=>btoa(unescape(encodeURIComponent(JSON.stringify(o)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const fromSnap=s=>{const p=(4-(s.length%4))%4; const b=s.replace(/-/g,'+').replace(/_/g,'/')+'='.repeat(p); return JSON.parse(decodeURIComponent(escape(atob(b))))};
  const relSnap=()=>location.pathname+location.search+'#d='+toSnap(data);
  const relLive=()=>location.pathname+location.search+'#r='+roomId;
  const abs=r=>location.origin+r;

  function updateShareLink(){ const i=document.getElementById('share-link'); if(!i) return; i.value=abs(liveMode&&roomId?relLive():relSnap()); if(sharedMode) history.replaceState({},'',relSnap()); }

  function newRoomId(){ const b=new Uint8Array(16); crypto.getRandomValues(b); return btoa(String.fromCharCode(...b)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'') }
  function liveEndpoint(){ return location.origin+`/live/${roomId}` }
  function startLive(){ if(!roomId) return; es&&es.close(); es=new EventSource(liveEndpoint()); es.onmessage=e=>{ try{ const incoming=JSON.parse(e.data); if(JSON.stringify(incoming)!==JSON.stringify(data)){ data=incoming; save(); render(); } }catch{} }; liveMode=true; sharedMode=false; updateShareLink(); }
  function pushLive(){ if(!(liveMode&&roomId)) return; fetch(liveEndpoint(),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)}).catch(()=>{}) }

  function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')}catch{return{}} }
  function save(){ try{localStorage.setItem(STORAGE_KEY,JSON.stringify(data))}catch{} }

  function inc(){ const k=_currentDay||todayKey(); data[k]=(Number(data[k]||0)+1); save(); render(); updateShareLink(); pushLive(); }
  function dec(){ const k=_currentDay||todayKey(); data[k]=Math.max(0, Number(data[k]||0)-1); save(); render(); updateShareLink(); pushLive(); }
  function resetToday(){ if(!confirm('Heute wirklich auf 0 setzen?')) return; const k=_currentDay||todayKey(); data[k]=0; save(); render(); updateShareLink(); pushLive(); }
  function delDay(key){ if(!confirm('Tag wirklich löschen?')) return; delete data[key]; save(); render(); updateShareLink(); pushLive(); }

  function render(){
    _currentDay=todayKey();
    document.getElementById('today-date').textContent=displayDateFromKey(_currentDay);
    document.getElementById('today-value').textContent=String(Number(data[_currentDay]||0));
    const tb=document.getElementById('days-body'); tb.innerHTML='';
    Object.keys(data).sort((a,b)=>a<b?1:-1).forEach(k=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${displayDateFromKey(k)}</td><td>${data[k]}</td><td><button class="btn" data-action="del" data-key="${k}">Löschen</button></td>`;
      tb.appendChild(tr);
    });
  }

  function parseHash(){ const h=location.hash||''; lastHash=h;
    if(h.startsWith('#d=')){ try{ data=fromSnap(h.slice(3)); sharedMode=true; liveMode=false; roomId=null; save(); }catch{} }
    else if(h.startsWith('#r=')){ roomId=h.slice(3); startLive(); }
  }
  window.addEventListener('hashchange', ()=>{ if(location.hash!==lastHash){ parseHash(); render(); } });

  document.addEventListener('click', async (e)=>{
    const a=e.target.closest('[data-action]');
    if(a){
      const act=a.dataset.action;
      if(act==='inc') return inc();
      if(act==='dec') return dec();
      if(act==='reset') return resetToday();
      if(act==='del') return delDay(a.dataset.key);
      if(act==='share'){
        if(e.shiftKey){ if(!roomId) roomId=newRoomId(); liveMode=true; sharedMode=false; history.replaceState({},'',relLive()); updateShareLink(); startLive(); pushLive(); const L=abs(relLive()); try{ await navigator.clipboard.writeText(L)}catch{}; return; }
        sharedMode=true; liveMode=false; updateShareLink(); const L=abs(relSnap()); try{ await navigator.clipboard.writeText(L)}catch{}; return;
      }
    }
    const n=e.target.closest('[data-nav]'); if(n){ const v=n.dataset.nav; document.getElementById('view-nies').hidden=(v!=='nies'); document.getElementById('view-wetter').hidden=(v!=='wetter'); document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.nav===v)); }
  });

  // Wetter (Open-Meteo)
  async function geocode(q){ const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&language=de`); const j=await r.json(); return j.results&&j.results[0] }
  async function wfetch(lat,lon,tz='auto'){ const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum&timezone=${tz}&forecast_days=7&language=de`; const r=await fetch(url); return r.json() }
  function wdesc(code){const m={0:'Klar',1:'Überwiegend klar',2:'Teilweise bewölkt',3:'Bedeckt',61:'Regen leicht',63:'Regen',65:'Regen stark',80:'Schauer leicht',81:'Schauer',82:'Schauer stark',95:'Gewitter'}; return m[code]||'—'}
  async function wSearch(){
    const qs=document.getElementById('weather-q').value.trim(); if(!qs) return;
    const hit=await geocode(qs); if(!hit) {alert('Ort nicht gefunden'); return;}
    document.getElementById('weather-location').textContent = hit.name + (hit.country?', '+hit.country:'');
    const data=await wfetch(hit.latitude, hit.longitude, hit.timezone||'auto');
    document.getElementById('w-now-temp').textContent=Math.round(data.current.temperature_2m)+'°C';
    document.getElementById('w-now-feels').textContent=Math.round(data.current.apparent_temperature)+'°C';
    document.getElementById('w-now-rain').textContent=(data.current.precipitation||0)+' mm';
    document.getElementById('w-now-wind').textContent=Math.round(data.current.wind_speed_10m)+' km/h';
    document.getElementById('w-now-desc').textContent=wdesc(data.current.weather_code);
    const tb=document.getElementById('w-forecast'); tb.innerHTML='';
    for(let i=0;i<data.daily.time.length;i++){const dt=new Date(data.daily.time[i]+'T12:00:00');const dd=String(dt.getDate()).padStart(2,'0');const mm=String(dt.getMonth()+1).padStart(2,'0');const yyyy=dt.getFullYear();const tr=document.createElement('tr');tr.innerHTML=`<td>${dd}.${mm}.${yyyy}</td><td>${Math.round(data.daily.temperature_2m_max[i])}° / ${Math.round(data.daily.temperature_2m_min[i])}°</td><td>${Math.round(data.daily.precipitation_sum[i]||0)}</td><td>${wdesc(data.daily.weather_code[i])}</td>`;tb.appendChild(tr);}
  }
  document.addEventListener('click', (e)=>{ const w=e.target.closest('[data-weather]'); if(!w) return; if(w.dataset.weather==='search') wSearch(); if(w.dataset.weather==='refresh') { const t=document.getElementById('weather-location').textContent.trim(); if(t&&t!=='—') wSearch(); } });

  // init
  function init(){ data=load(); parseHash(); render(); document.getElementById('view-nies').hidden=false; document.getElementById('view-wetter').hidden=true; document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b.dataset.nav==='nies')); document.getElementById('today-date').textContent=displayDateFromKey(todayKey()); }
  document.addEventListener('DOMContentLoaded', init, {once:true});
})();</script>
</body></html>
